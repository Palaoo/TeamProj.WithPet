<!DOCTYPE html>
<html lang="en">
<html xmlns:th="http://www.thymeleaf.org">
<head>
    <meta charset="UTF-8">
    <title>Title</title>
    <meta http-equiv="X-UA-Compatible" content="IE=edge">
    <meta name="viewport" content="width=<device-width>, initial-scale=1.0">
    <title>Document</title>
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.1.3/dist/css/bootstrap.min.css" rel="stylesheet"
          integrity="sha384-1BmE4kWBq78iYhFldvKuhfTAU6auU8tT94WrHftjDbrCEXSU1oBoqyl2QvZ6jIW3" crossorigin="anonymous">
    <link href="/assets/css/star.css" rel="stylesheet"/>
    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.1.3/dist/js/bootstrap.bundle.min.js"
            integrity="sha384-ka7Sk0Gln4gmtz2MlQnikT1wXgYsOg+OMhuP+IlRH9sENBO0LRn5q+8nbTov4+1p"
            crossorigin="anonymous"></script>
    <th:block th:replace="fragments/index::style"></th:block>
</head>
<style>
    #img {
        width: 736px;
        height: 400px;
    }

    #submit, #book {
        background-color: #000;
        color: white;
    }

    #submit:hover, #book:hover {
        background: white;
        border: 1px solid;
        color: #518581;
    }

    #myform fieldset {
        display: inline-block;
        direction: rtl;
        border: 0;
    }

    #myform fieldset legend {
        text-align: right;
    }

    #myform input[type=radio] {
        display: none;
    }

    #myform label {
        font-size: 3em;
        color: transparent;
        text-shadow: 0 0 0 #f0f0f0;
    }

    #myform label:hover {
        text-shadow: 0 0 0 rgba(250, 208, 0, 0.99);
    }

    #myform label:hover ~ label {
        text-shadow: 0 0 0 rgba(250, 208, 0, 0.99);
    }

    #myform input[type=radio]:checked ~ label {
        text-shadow: 0 0 0 rgba(250, 208, 0, 0.99);
    }

    #reviewContents {
        width: 100%;
        height: 150px;
        padding: 10px;
        box-sizing: border-box;
        border: solid 1.5px #D3D3D3;
        border-radius: 5px;
        font-size: 16px;
        resize: none;
    }

    .rating {
        color: transparent;
        text-shadow: 0 0 0 gold;
    }

    div.updatescore fieldset {
        display: inline-block;
        direction: rtl;
        border: 0;
    }

    div.updatescore fieldset legend {
        text-align: right;
    }

    div.updatescore input[type=radio] {
        display: none;
    }

    div.updatescore label {
        font-size: 3em;
        color: transparent;
        text-shadow: 0 0 0 #f0f0f0;
    }

    div.updatescore label:hover {
        text-shadow: 0 0 0 rgba(250, 208, 0, 0.99);
    }

    div.updatescore label:hover ~ label {
        text-shadow: 0 0 0 rgba(250, 208, 0, 0.99);
    }

    div.updatescore input[type=radio]:checked ~ label {
        text-shadow: 0 0 0 rgba(250, 208, 0, 0.99);
    }
</style>
<body>

<div th:replace="fragments/index :: header"></div>

<!--version2-->
<section class="blog-hero spad">
    <div class="container">
        <div class="row d-flex justify-content-center">
            <div class="col-lg-9 text-center">
                <div class="blog__hero__text">
                    <h2 th:text="${shop.getName()}"></h2>
                    <h6 th:text="${shop.getIntro()}"></h6>
                    <ul>
                        <li>
                            <a href="javascript:return false;" id="btnLike" th:name="${shop.getShopid()}">
                                <img th:if="${liked==1}" src="/image/redheart.png"
                                     th:id="|btnLike${shop.getShopid()}|" width="25" height="25" alt="">
                                <img th:if="${liked==0}" src="/image/heart.png"
                                     th:id="|btnLike${shop.getShopid()}|" width="25" height="25" alt="">
                                <p th:text="${likeCount}" th:id="|likeCount${shop.getShopid()}|"
                                   name="likeCount" id="cnt"></p>
                            </a>
                        </li>
<!--                        <li>-->
<!--                            <div class="rating">-->
<!--                                <i class="fa fa-star"></i>-->
<!--                                <i class="fa fa-star"></i>-->
<!--                                <i class="fa fa-star"></i>-->
<!--                                <i class="fa fa-star"></i>-->
<!--                                <i class="fa fa-star-o"></i>-->
<!--                                <span> - 5 Reviews</span>-->
<!--                            </div>-->
<!--                        </li>-->
                        <li>
                            <th:block th:each="feat : ${feats}">
                                <span th:text="${feat.getFeatname()}"></span>
                            </th:block>
                            <br>
                        </li>
                    </ul>
                </div>
            </div>
        </div>
    </div>
</section>
<section class="blog-details spad">
    <div class="container">
        <div class="row d-flex justify-content-center">
            <div class="col-lg-8">
                <div class="blog__details__content">
                    <div class="container">
                        <div class="blog__details__pic">
                            <img id="img" class="col" th:src="${shopimg}" style="size: auto">
                        </div>

                        <!--상세설명-->
                        <div class="row">
                            <div class="col-lg-12">
                                <div class="product__details__tab">
                                    <ul class="nav nav-tabs" role="tablist" id="myTab">
                                        <li class="nav-item">
                                            <a class="nav-link active" data-toggle="tab" href="#tabs-1"
                                               role="tab">이용안내</a>
                                        </li>
                                        <li class="nav-item">
                                            <a class="nav-link" data-toggle="tab" href="#tabs-2" role="tab">기본정보</a>
                                        </li>
                                        <li class="nav-item">
                                            <a class="nav-link" data-toggle="tab" href="#tabs-3" role="tab">사용자후기</a>
                                        </li>
                                        <li class="nav-item">
                                            <a class="nav-link" data-toggle="tab" href="#tabs-4" role="tab">블로그후기</a>
                                        </li>
                                    </ul>

                                    <div class="tab-content">
                                        <div class="tab-pane active" id="tabs-1" role="tabpanel">
                                            <div class="product__details__tab__content">
                                                <th:block th:text="${shop.getInfo()}"></th:block>

                                                <form action="/hotel/booking" method="post">
                                                    <div class="row">
                                                        <div class="datebar" style="margin:10px">
                                                            <input type="hidden" name="shopid" id="shopid"
                                                                   th:value="${shop.getShopid()}">
                                                            <input type="date" name="checkin" id="checkin"
                                                                   th:value="${checkin}">&nbsp;
                                                            <input type="date" name="checkout" id="checkout"
                                                                   th:value="${checkout}">&nbsp;
                                                            인원수&nbsp;<input type="text" name="person" id="person"
                                                                            th:value="${person}" readonly>&nbsp;
                                                            <input type="button" value="변경" id="submit">
                                                        </div>
                                                    </div>
                                                    <br>
                                                    <div id="rooms">
                                                        <div class="row" th:each="hotelroom:${hotelrooms}"
                                                             style="width: 700px; height:130px">
                                                            <img class="col-4" th:src="${hotelroom.getPath()}"
                                                                 style="width: 200px; height: 100px">
                                                            <div class="col-4">
                                                                <input type="hidden" th:value="${hotelroom.getRoomid()}"
                                                                       name="roomid">
                                                                <span th:text="${hotelroom.getRoomname()}"></span><br>
                                                                <span th:text="${hotelroom.getContent()}"></span><br>
                                                                <span th:text="${hotelroom.getPerson()}"></span><br>
                                                                <span th:if="${#strings.equals(hotelroom.getAvail(), 'true')}"
                                                                      th:text="|${hotelroom.getPrice()}원|"></span>
                                                                <span th:unless="${#strings.equals(hotelroom.getAvail(), 'true')}">예약 마감</span><br>

                                                            </div>
                                                            <div id="dv_book" class="col-4">
                                                                <br>
                                                                <input type="submit" style="float: right" value="예약하기"
                                                                       id="book"></div>
                                                        </div>
                                                    </div>
                                                </form>
                                            </div>
                                        </div>

                                        <div class="tab-pane" id="tabs-2" role="tabpanel"> <!-- active-->
                                            <div class="product__details__tab__content">
                                                <div class="product__details__tab__content__item">
                                                    <div id="map"
                                                         style="width:700px !important;height:300px !important;"></div>
                                                    <div>
                                                        <br>
                                                        전화번호: <span th:text="${shop.getTel()}"></span><br>
                                                        주소: <span th:text="${shop.getAddress()}" id="address"></span>
                                                    </div>
                                                </div>
                                            </div>
                                        </div>

                                        <div class="tab-pane" id="tabs-3" role="tabpanel">
                                            <div class="product__details__tab__content">
                                                <div class="product__details__tab__content__item">

                                                    <span th:text="${#lists.size(shopreview)}"></span>개
                                                    <th:block th:each="review , index : ${shopreview}">
                                                        <div class="row">
                                                            <div class="col-sm-2">
                                                                <p th:text="${review.getUserid()}"></p></div>
                                                            <div class="col-sm-5">
                                                                <th:block th:if="${review.getScore()==5}">
                                                                    <div class="rating">★★★★★</div>
                                                                </th:block>
                                                                <th:block th:if="${review.getScore()==4}">
                                                                    <div class="rating">★★★★</div>
                                                                </th:block>
                                                                <th:block th:if="${review.getScore()==3}">
                                                                    <div class="rating">★★★</div>
                                                                </th:block>
                                                                <th:block th:if="${review.getScore()==2}">
                                                                    <div class="rating">★★</div>
                                                                </th:block>
                                                                <th:block th:if="${review.getScore()==1}">
                                                                    <div class="rating">★</div>
                                                                </th:block>
                                                                <p id="content1" th:text="${review.getContent()}"></p>
                                                            </div>
                                                            <div class="col-sm-2">
                                                                <p th:text="${review.getDate()}"></p>
                                                            </div>

                                                            <div class="col-sm-2">
                                                                <div th:if="${review.getUserid()==userid}">
                                                                    <form th:action="@{'/reviews/updatehotel'}"
                                                                          method="post">
                                                                        <input type="hidden" name="rid"
                                                                               th:value="${review.getRid()}">
                                                                        <button type="button" th:id="${index}"
                                                                                class="btn btn-outline-primary btn-sm"
                                                                                data-bs-toggle="modal"
                                                                                data-bs-target="#review-edit-Modal"
                                                                                th:attr="data-bs-content=${review.getContent()},
                                                                                    data-bs-score=${review.getScore()},
                                                                                    data-bs-rid=${review.getRid()}"
                                                                                data-bs-userid=""
                                                                                data-bs-shopid="">수정
                                                                        </button>
                                                                        <div class="modal fade" id="review-edit-Modal"
                                                                             tabindex="-1"
                                                                             aria-labelledby="exampleModalLabel"
                                                                             aria-hidden="true">
                                                                            <div class="modal-dialog">
                                                                                <div class="modal-content">
                                                                                    <div class="modal-header">
                                                                                        <h5 class="modal-title"
                                                                                            id="exampleModalLabel">리뷰
                                                                                            수정하기</h5>
                                                                                        <button type="button"
                                                                                                class="btn-close"
                                                                                                data-bs-dismiss="modal"
                                                                                                aria-label="Close"></button>
                                                                                    </div>
                                                                                    <div class="modal-body">
                                                                                        <div class="updatescore">
                                                                                            <fieldset>
                                                                                                <span class="text-bold">별점을 선택하세요</span>
                                                                                                <input type="radio"
                                                                                                       name="score"
                                                                                                       value="5"
                                                                                                       id="rate1_"><label
                                                                                                    for="rate1_">★</label>
                                                                                                <input type="radio"
                                                                                                       name="score"
                                                                                                       value="4"
                                                                                                       id="rate2_"><label
                                                                                                    for="rate2_">★</label>
                                                                                                <input type="radio"
                                                                                                       name="score"
                                                                                                       value="3"
                                                                                                       id="rate3_"><label
                                                                                                    for="rate3_">★</label>
                                                                                                <input type="radio"
                                                                                                       name="score"
                                                                                                       value="2"
                                                                                                       id="rate4_"><label
                                                                                                    for="rate4_">★</label>
                                                                                                <input type="radio"
                                                                                                       name="score"
                                                                                                       value="1"
                                                                                                       id="rate5_"><label
                                                                                                    for="rate5_">★</label>
                                                                                            </fieldset>
                                                                                        </div>
                                                                                        <div class="mb-3">
                                                                                            <label for="message-text"
                                                                                                   class="col-form-label">내용</label>
                                                                                            <textarea
                                                                                                    class="form-control"
                                                                                                    id="message-text"
                                                                                                    name="content"></textarea>
                                                                                            <input type="hidden"
                                                                                                   name="rid"
                                                                                                   id="review-id">
                                                                                        </div>
                                                                                        <input type="hidden"
                                                                                               name="shopid"
                                                                                               th:value="${review.getShopid()}">
                                                                                        <input type="hidden" name="rid"
                                                                                               th:value="${review.getRid()}">
                                                                                        <input type="hidden"
                                                                                               name="userid"
                                                                                               th:value="${review.getUserid()}">
                                                                                        <input type="hidden" name="date"
                                                                                               id="currentTime"
                                                                                               th:value="${review.getDate()}">
                                                                                        <input type="hidden"
                                                                                               name="score"
                                                                                               id="score-value">
                                                                                    </div>

                                                                                    <script>
                                                                                        document.getElementById("currentTime").value = new Date(+new Date() + 3240 * 10000).toISOString().split("T")[0];
                                                                                    </script>

                                                                                    <div class="modal-footer">
                                                                                        <button type="button"
                                                                                                class="btn btn-secondary"
                                                                                                data-bs-dismiss="modal">
                                                                                            닫기
                                                                                        </button>
                                                                                        <button type="submit"
                                                                                                class="btn btn-primary">
                                                                                            수정
                                                                                        </button>
                                                                                    </div>
                                                                                </div>
                                                                            </div>
                                                                        </div>
                                                                    </form>
                                                                    <script>
                                                                        var myModal = document.getElementById('myModal')
                                                                        var myInput = document.getElementById('myInput')

                                                                        myModal.addEventListener('shown.bs.modal', function () {
                                                                            myInput.focus()
                                                                        })
                                                                    </script>
                                                                    <!--리뷰 삭제-->
                                                                    <form th:action="@{'/reviews/deletehotel/'}"
                                                                          method="get">
                                                                        <input type="hidden" name="shopid"
                                                                               th:value="${review.getShopid()}">
                                                                        <input type="hidden" name="rid"
                                                                               th:value="${review.getRid()}">
                                                                        <button class="btn btn-outline-danger btn-sm"
                                                                                name="delete">삭제
                                                                        </button>
                                                                    </form>
                                                                </div>
                                                            </div>
                                                        </div>
                                                    </th:block>

                                                    <!--후기 남기기-->
                                                    <div th:if="${not #strings.isEmpty(userid)}">
                                                        <form class="mb-3" name="myform" id="myform"
                                                              action="/reviews/createhotel" method="post"
                                                              onsubmit="return submitCheck();">
                                                            <fieldset>
                                                                <button type="submit"
                                                                        class="btn btn-outline-primary btn-sm"
                                                                        id="comment-create-btn">후기 작성
                                                                </button>
                                                                <span class="text-bold">별점을 선택하세요</span>
                                                                <input type="radio" name="score" value="5"
                                                                       id="rate1"><label
                                                                    for="rate1">★</label>
                                                                <input type="radio" name="score" value="4"
                                                                       id="rate2"><label
                                                                    for="rate2">★</label>
                                                                <input type="radio" name="score" value="3"
                                                                       id="rate3"><label
                                                                    for="rate3">★</label>
                                                                <input type="radio" name="score" value="2"
                                                                       id="rate4"><label
                                                                    for="rate4">★</label>
                                                                <input type="radio" name="score" value="1"
                                                                       id="rate5"><label
                                                                    for="rate5">★</label>
                                                            </fieldset>
                                                            <div>
                                                                <input type="hidden" th:value="${shop.getShopid()}"
                                                                       name="shopid">
                                                                <input type="hidden" th:value="${userid}" name="userid">
                                                                <textarea class="col-auto form-control" type="text"
                                                                          id="content" name="content"
                                                                          placeholder="후기를 남겨주세요"></textarea>

                                                            </div>
                                                        </form>
                                                    </div>
                                                </div>
                                            </div>
                                        </div>

                                        <div class="tab-pane" id="tabs-4" role="tabpanel">
                                            <div class="product__details__tab__content">
                                                <div class="product__details__tab__content__item">
                                                    <div class="card mb-3" th:each="item:${review.items}"
                                                         style="width: 700px">
                                                        <a th:href="${item.link}">
                                                            <div class="card-body">
                                                                <h4 class="card-title" th:utext="${item.title}"></h4>
                                                                <br>
                                                                <p class="card-text" th:utext="${item.description}"></p>
                                                                <br>
                                                                <p class="card-text">
                                                                    <small class="text-muted"
                                                                           th:utext="${item.bloggername}"></small>&nbsp;
                                                                    <small class="text-muted"
                                                                           th:utext="${item.postdate}"></small>
                                                                </p>
                                                            </div>
                                                        </a>
                                                    </div>
                                                    <div class="postbar" style="clear:both; text-align: center;">
                                                        <a th:href="@{https://search.naver.com/search.naver(query=${shop.getName()})}">검색
                                                            결과 더 보기</a>
                                                    </div>
                                                    <br>
                                                </div>
                                            </div>
                                        </div>
                                    </div>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>
</section>
<th:block th:replace="fragments/index :: footer"></th:block>

<script type="text/javascript"
        src="//dapi.kakao.com/v2/maps/sdk.js?appkey=55427368a7ad4ced6d2416666f61ad47&libraries=services"></script>
</body>
<script>
    const triggerTabList = document.querySelectorAll('#myTab a')
    triggerTabList.forEach(triggerEl => {
        const tabTrigger = new bootstrap.Tab(triggerEl)

        triggerEl.addEventListener('click', event => {
            event.preventDefault()
            tabTrigger.show()
        })
    })


    $(document)
        .on("click", "#comment-create-btn", function () {
            if ($(':radio[name="score"]:checked').length < 1) {
                alert("별점을 선택해주세요.");
                return false;
            }
        })

        .on('click', '#submit', function () {
            var today = new Date().toISOString().substring(0, 10)

            if ($('#checkin').val() >= $('#checkout').val() || $('#checkin').val() < today) {
                alert("날짜를 확인해주세요.")
                return false;
            } else if ($('#person').val() <= 0) {
                alert("인원수를 확인해주세요.")
                return false;
            }

            $.ajax({
                url: "/hotel/detail",
                type: "post",
                data: {
                    shopid: $('#shopid').val(), checkin: $('#checkin').val(),
                    checkout: $('#checkout').val(), person: $('#person').val()
                },
                success: function (r) {
                    $('#rooms').empty()
                    var str = ""
                    $.each(r, function (index, item) {
                        str += '<div class="row" style="width: 700px; height:130px">'
                        str += '<img className="col-4" src="' + item["path"] + '" style="width: 200px; height: 100px">'
                        str += '<div class="col">'
                        str += '<span>' + item["roomname"] + '</span><br>'
                        str += '<span>' + item["content"] + '</span><br>'
                        str += '<span>' + item["person"] + '</span><br>'
                        if (item["avail"] == "true") {
                            str += '<span>' + item["price"] + '원</span><br>'
                        } else {
                            str += '<span>예약 마감</span><br>'
                        }
                        str += '<input type="submit" style="float: right" value="예약하기" id="book">'
                        str += '</div>'
                        str += '</div>'
                    })
                    $('#rooms').html(str)
                }
            })

        })

        .on('click', '#book', function () {
            $.ajax({
                url: "/checkuser",
                type: "post",
                async: false,
                success: function (result) {
                    if (result == true) {
                        flag = true;
                    } else {
                        alert('로그인이 필요한 서비스입니다')
                        location.href = "/login"
                        flag = false
                    }
                }
            })
            return flag;
        })

        .on('click', '#btnLike', function () {
            shopId = $(this).attr('name')
            console.log(shopId)
            $.ajax({
                type: 'get',
                url: '/append_likehotel?shopId=' + shopId,
                success: function (data) {
                    ID = '#btnLike' + shopId
                    if (data == '1') {
                        $(ID).attr("src", "/image/redheart.png")
                        $(ID).attr("width", "25px")
                        $(ID).attr("height", "25px")
                        $('#likeCount' + shopId).text(parseInt($('#likeCount' + shopId).text()) + 1)
                    } else {
                        console.log('여기')
                        $(ID).attr("width", "25px")
                        $(ID).attr("height", "25px")
                        $(ID).attr("src", "/image/heart.png")
                        $('#likeCount' + shopId).text(parseInt($('#likeCount' + shopId).text()) - 1)
                    }
                }
            })
        })


    var mapContainer = document.getElementById('map'), // 지도를 표시할 div

        mapOption = {
            center: new kakao.maps.LatLng(33.450701, 126.570667), // 지도의 중심좌표
            level: 3 // 지도의 확대 레벨
        };
    // 지도를 생성합니다
    var map = new kakao.maps.Map(mapContainer, mapOption);
    // 주소-좌표 변환 객체를 생성합니다

    $("a[href='#tabs-2']").on('shown.bs.tab', function(){
        kakao.maps.event.trigger(map, resizeMap());
        relayout()
        getCenter()
    });

    function getCenter(){
        var geocoder = new kakao.maps.services.Geocoder();
        // 주소로 좌표를 검색합니다
        geocoder.addressSearch(document.getElementById("address").innerHTML, function (result, status) {
            // 정상적으로 검색이 완료됐으면
            if (status === kakao.maps.services.Status.OK) {
                var coords = new kakao.maps.LatLng(result[0].y, result[0].x);
                // 결과값으로 받은 위치를 마커로 표시합니다
                var marker = new kakao.maps.Marker({
                    map: map,
                    position: coords
                });
                // 지도의 중심을 결과값으로 받은 위치로 이동시킵니다
                map.setCenter(coords);
            }
        });
    }

    function resizeMap() {
        var mapContainer = document.getElementById('map');
        mapContainer.style.width = '700px';
        mapContainer.style.height = '300px';
    }

    function relayout() {
        map.relayout();
    }

    const commentEditModal = document.querySelector("#review-edit-Modal")

    commentEditModal.addEventListener("show.bs.modal", function (event) {

        const triggerBtn = event.relatedTarget

        const content = triggerBtn.getAttribute("data-bs-content");
        const score = triggerBtn.getAttribute("data-bs-score");
        const rid = triggerBtn.getAttribute("data-bs-rid");

        console.log(rid);
        document.querySelector("#message-text").value = content
        document.querySelector("#score-value").value = score
        document.querySelector("#review-id").value = rid
    })
</script>
</html>